# è®­ç»ƒæ•°æ®éªŒè¯å’Œæ¸…ç†å·¥å…·

## åŠŸèƒ½è¯´æ˜

è¿™ä¸ªå·¥å…·ç”¨äºéªŒè¯è®­ç»ƒæ•°æ®é›†ä¸­çš„Leanä»£ç æ˜¯å¦æ­£ç¡®ï¼Œå¹¶è‡ªåŠ¨åˆ é™¤ä¸æ­£ç¡®çš„æ•°æ®ã€‚

### ä¸»è¦åŠŸèƒ½

1. âœ… **éªŒè¯Leanä»£ç ** - æ£€æŸ¥æ¯ä¸ªæ ·æœ¬çš„Leanä»£ç æ˜¯å¦èƒ½é€šè¿‡ç¼–è¯‘
2. ğŸ—‘ï¸ **è‡ªåŠ¨æ¸…ç†** - åˆ é™¤éªŒè¯å¤±è´¥çš„æ ·æœ¬
3. ğŸ“Š **è¯¦ç»†æŠ¥å‘Š** - ç”ŸæˆéªŒè¯ç»Ÿè®¡æŠ¥å‘Šå’Œé”™è¯¯è¯¦æƒ…
4. ğŸ” **é”™è¯¯è¿½è¸ª** - ä¿å­˜æ‰€æœ‰éªŒè¯å¤±è´¥çš„æ ·æœ¬åŠå…¶é”™è¯¯ä¿¡æ¯
5. âš¡ **å¢é‡æ”¯æŒ** - æ”¯æŒéªŒè¯æŒ‡å®šæ•°é‡çš„æ ·æœ¬è¿›è¡Œæµ‹è¯•

## å¿«é€Ÿå¼€å§‹

### æ–¹æ³•1: ä½¿ç”¨PowerShellè„šæœ¬ (æ¨è)

```powershell
# éªŒè¯æ‰€æœ‰æ•°æ®
.\run_validation_and_clean.ps1

# å…ˆéªŒè¯å‰100ä¸ªæ ·æœ¬è¿›è¡Œæµ‹è¯•
.\run_validation_and_clean.ps1 -MaxSamples 100

# è‡ªå®šä¹‰è¾“å…¥è¾“å‡ºè·¯å¾„
.\run_validation_and_clean.ps1 -InputFile "data/step3_consensus_v2/enhanced_consensus.jsonl" `
                                -OutputFile "data/validated/consensus_valid.jsonl"

# å¯ç”¨è°ƒè¯•æ¨¡å¼æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯
.\run_validation_and_clean.ps1 -Debug

# ä¸ä¿å­˜æ— æ•ˆæ•°æ®è¯¦æƒ…(èŠ‚çœç©ºé—´)
.\run_validation_and_clean.ps1 -NoSaveInvalid
```

### æ–¹æ³•2: ç›´æ¥ä½¿ç”¨Pythonè„šæœ¬

```bash
# éªŒè¯æ‰€æœ‰æ•°æ®
python validate_and_clean_training_data.py

# éªŒè¯å‰100ä¸ªæ ·æœ¬
python validate_and_clean_training_data.py --max-samples 100

# è‡ªå®šä¹‰å‚æ•°
python validate_and_clean_training_data.py \
    --input data/step3_consensus_v2/enhanced_consensus.jsonl \
    --output data/validated/consensus_valid.jsonl \
    --timeout 60 \
    --max-workers 1
```

## å‚æ•°è¯´æ˜

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `--input` | è¾“å…¥æ–‡ä»¶è·¯å¾„ | `data/step3_consensus_v2/enhanced_consensus.jsonl` |
| `--output` | è¾“å‡ºæ–‡ä»¶è·¯å¾„(ä»…ä¿å­˜æœ‰æ•ˆæ•°æ®) | `data/validated/consensus_valid.jsonl` |
| `--max-samples` | æœ€å¤§éªŒè¯æ ·æœ¬æ•°(0=å…¨éƒ¨) | `0` |
| `--timeout` | å•ä¸ªæ ·æœ¬éªŒè¯è¶…æ—¶æ—¶é—´(ç§’) | `60` |
| `--max-workers` | å¹¶è¡ŒéªŒè¯çº¿ç¨‹æ•° | `1` |
| `--no-save-invalid` | ä¸ä¿å­˜æ— æ•ˆæ•°æ®è¯¦æƒ… | `false` |
| `--debug` | å¯ç”¨è°ƒè¯•æ¨¡å¼ | `false` |

## è¾“å‡ºæ–‡ä»¶

éªŒè¯å®Œæˆåä¼šç”Ÿæˆä»¥ä¸‹æ–‡ä»¶:

1. **`consensus_valid.jsonl`** - éªŒè¯é€šè¿‡çš„æœ‰æ•ˆæ•°æ®(ç”¨äºè®­ç»ƒ)
2. **`consensus_valid_errors.jsonl`** - éªŒè¯å¤±è´¥çš„æ•°æ®è¯¦æƒ…
3. **`consensus_valid_report.txt`** - è¯¦ç»†çš„éªŒè¯æŠ¥å‘Š

## éªŒè¯æµç¨‹

```
è¾“å…¥æ•°æ® â†’ æå–Leanä»£ç  â†’ æ£€æŸ¥å®Œæ•´æ€§ â†’ ç¼–è¯‘éªŒè¯ â†’ åˆ†ç±»ä¿å­˜
                â†“              â†“            â†“          â†“
            æ— ä»£ç ?        åŒ…å«sorry?    ç¼–è¯‘é”™è¯¯?   æœ‰æ•ˆ/æ— æ•ˆ
```

### éªŒè¯è§„åˆ™

æ•°æ®ä¼šåœ¨ä»¥ä¸‹æƒ…å†µè¢«åˆ é™¤:

- âŒ **æ— æ³•æå–Leanä»£ç ** - æ•°æ®ä¸­æ²¡æœ‰å¯ç”¨çš„theoremå’Œproofå­—æ®µ
- âŒ **åŒ…å«sorry** - è¯æ˜ä¸å®Œæ•´,åŒ…å«`sorry`å ä½ç¬¦
- âŒ **ç¼–è¯‘é”™è¯¯** - Leanä»£ç æ— æ³•é€šè¿‡ç¼–è¯‘

## ç¤ºä¾‹éªŒè¯æŠ¥å‘Š

```
================================================================================
è®­ç»ƒæ•°æ®éªŒè¯æŠ¥å‘Š
================================================================================

æ€»æ ·æœ¬æ•°: 996
æœ‰æ•ˆæ ·æœ¬: 723 (72.59%)
æ— æ•ˆæ ·æœ¬: 273 (27.41%)
  - æ— ä»£ç : 12
  - ç¼–è¯‘é”™è¯¯: 261

é”™è¯¯ç±»å‹ç»Ÿè®¡:
  compilation_error: 261
  no_code: 12

================================================================================
å‰10ä¸ªé”™è¯¯ç¤ºä¾‹:
================================================================================

1. [compilation_error] theorem sdiff_sup :=
   è¡Œå·: 2
   é”™è¯¯: type mismatch, term has type ...

2. [no_code] theorem example_without_proof
   è¡Œå·: 45
   é”™è¯¯: æ— æ³•æå–æœ‰æ•ˆçš„Leanä»£ç 
...
```

## ä½¿ç”¨åœºæ™¯

### åœºæ™¯1: é¦–æ¬¡éªŒè¯æ•°æ®é›†

```powershell
# å…ˆç”¨å°‘é‡æ ·æœ¬æµ‹è¯•
.\run_validation_and_clean.ps1 -MaxSamples 10 -Debug

# ç¡®è®¤æ— è¯¯åéªŒè¯å…¨éƒ¨
.\run_validation_and_clean.ps1
```

### åœºæ™¯2: å®šæœŸæ¸…ç†æ•°æ®

```powershell
# å®šæœŸè¿è¡Œä»¥ç¡®ä¿æ•°æ®è´¨é‡
.\run_validation_and_clean.ps1 -InputFile "data/new_batch.jsonl" `
                                -OutputFile "data/validated/new_batch_clean.jsonl"
```

### åœºæ™¯3: è°ƒè¯•éªŒè¯é—®é¢˜

```powershell
# å¯ç”¨è°ƒè¯•æŸ¥çœ‹æ¯ä¸ªæ ·æœ¬çš„è¯¦ç»†éªŒè¯ä¿¡æ¯
.\run_validation_and_clean.ps1 -MaxSamples 5 -Debug
```

## æ€§èƒ½å»ºè®®

1. **é¦–æ¬¡è¿è¡Œ**: å»ºè®®ä½¿ç”¨ `-MaxSamples 100` å…ˆæµ‹è¯•å°‘é‡æ ·æœ¬
2. **å¹¶è¡Œæ•°é‡**: `--max-workers 1` æœ€ç¨³å®š,2-4å¯èƒ½æ›´å¿«ä½†å¯èƒ½ä¸ç¨³å®š
3. **è¶…æ—¶è®¾ç½®**: å¤§éƒ¨åˆ†æ ·æœ¬30ç§’å†…å®Œæˆ,å¤æ‚çš„å¯èƒ½éœ€è¦60-120ç§’
4. **Windowsæ…¢é€Ÿç¯å¢ƒ**: ç¬¬ä¸€æ¬¡è¿è¡Œä¼šè¾ƒæ…¢(ç¼“å­˜æ„å»º),åç»­ä¼šå¿«å¾ˆå¤š

## å¸¸è§é—®é¢˜

### Q: éªŒè¯é€Ÿåº¦å¾ˆæ…¢æ€ä¹ˆåŠ?

A: ç¬¬ä¸€æ¬¡è¿è¡ŒLeanä¼šæ„å»ºç¼“å­˜,å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ã€‚åç»­è¿è¡Œä¼šå¿«å¾ˆå¤šã€‚

### Q: æŸäº›æ ·æœ¬æ€»æ˜¯è¶…æ—¶?

A: å¢åŠ  `--timeout` å‚æ•°,ä¾‹å¦‚ `--timeout 120`

### Q: æƒ³è¦å¹¶è¡ŒéªŒè¯?

A: å¢åŠ  `--max-workers` å‚æ•°,ä½†æ³¨æ„å¯èƒ½ä¸ç¨³å®šã€‚å»ºè®®å…ˆç”¨ `--max-workers 2` æµ‹è¯•ã€‚

### Q: å¦‚ä½•æŸ¥çœ‹å…·ä½“å“ªäº›æ•°æ®è¢«åˆ é™¤äº†?

A: æŸ¥çœ‹ç”Ÿæˆçš„ `*_errors.jsonl` æ–‡ä»¶,åŒ…å«æ‰€æœ‰è¢«åˆ é™¤æ•°æ®çš„è¯¦ç»†ä¿¡æ¯ã€‚

### Q: éªŒè¯æŠ¥å‘Šåœ¨å“ªé‡Œ?

A: åœ¨è¾“å‡ºç›®å½•ä¸‹,æ–‡ä»¶åä¸º `*_report.txt`

## æŠ€æœ¯ç»†èŠ‚

### ä»£ç æå–ä¼˜å…ˆçº§

1. `backward_source.theorem` + `backward_source.proof`
2. é¡¶å±‚ `theorem` + `proof` å­—æ®µ
3. å…¶ä»–å­—æ®µ: `lean_code`, `code`, `complete_proof`

### éªŒè¯æ–¹æ³•

ä½¿ç”¨ `lake env lean` å‘½ä»¤ç¼–è¯‘æ¯ä¸ªLeanæ–‡ä»¶,ç¡®ä¿:
- ä»£ç è¯­æ³•æ­£ç¡®
- æ‰€æœ‰ä¾èµ–å¯è§£æ
- è¯æ˜å®Œæ•´(ä¸åŒ…å«sorry)

## ç›¸å…³æ–‡ä»¶

- `validate_and_clean_training_data.py` - ä¸»éªŒè¯è„šæœ¬
- `run_validation_and_clean.ps1` - PowerShellåŒ…è£…è„šæœ¬  
- `src/data_gen/validate_lean_code.py` - Leanä»£ç éªŒè¯æ ¸å¿ƒæ¨¡å—
- `test_validation.py` - å¿«é€Ÿæµ‹è¯•è„šæœ¬(éªŒè¯å°‘é‡æ ·æœ¬)

## æ›´æ–°æ—¥å¿—

### v1.0 (2025-12-13)
- âœ… åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
- âœ… æ”¯æŒè‡ªåŠ¨éªŒè¯å’Œæ¸…ç†
- âœ… ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
- âœ… é”™è¯¯è¯¦æƒ…ä¿å­˜
- âœ… æ”¯æŒå¢é‡éªŒè¯

---

**å»ºè®®**: åœ¨æ­£å¼è®­ç»ƒå‰,åŠ¡å¿…è¿è¡Œæ­¤å·¥å…·éªŒè¯å’Œæ¸…ç†è®­ç»ƒæ•°æ®,ä»¥ç¡®ä¿æ•°æ®è´¨é‡!
